import 'dart:io';
import 'dart:convert';
import 'package_name:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart';
import 'package:intl/intl.dart';
import 'package:file_picker/file_picker.dart';
import 'package:open_file_plus/open_file_plus.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Exam Scheduler',
      theme: ThemeData(
        primarySwatch: Colors.indigo,
        visualDensity: VisualDensity.adaptivePlatformDensity,
        useMaterial3: true,
        brightness: Brightness.dark,
        cardTheme: CardTheme(
          elevation: 2,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),
      ),
      home: const ExamListScreen(),
    );
  }
}

class Exam {
  final String id;
  final String courseCode;
  final DateTime date;
  final TimeOfDay time;
  final String venue;
  final String? documentPath;

  Exam({
    String? id,
    required this.courseCode,
    required this.date,
    required this.time,
    required this.venue,
    this.documentPath,
  }) : this.id = id ?? DateTime.now().millisecondsSinceEpoch.toString();

  DateTime get dateTime => DateTime(date.year, date.month, date.day, time.hour, time.minute);

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'courseCode': courseCode,
      'date': date.toIso8601String(),
      'time': '${time.hour.toString().padLeft(2, '0')}:${time.minute.toString().padLeft(2, '0')}',
      'venue': venue,
      'documentPath': documentPath,
    };
  }

  factory Exam.fromJson(Map<String, dynamic> map) {
    final timeParts = (map['time'] as String).split(':');
    return Exam(
      id: map['id'] as String,
      courseCode: map['courseCode'] as String,
      date: DateTime.parse(map['date'] as String),
      time: TimeOfDay(hour: int.parse(timeParts[0]), minute: int.parse(timeParts[1])),
      venue: map['venue'] as String,
      documentPath: map['documentPath'] as String?,
    );
  }
}

class ExamStorage {
  static const String _storageKey = "exam_list";

  static Future<List<Exam>> readAllExams() async {
    final prefs = await SharedPreferences.getInstance();
    
    final String? examString = prefs.getString(_storageKey);
    
    if (examString == null) {
      return [];
    }
    
    final List<dynamic> jsonList = jsonDecode(examString);
    
    return jsonList.map((json) => Exam.fromJson(json)).toList();
  }

  static Future<void> _saveExams(List<Exam> exams) async {
    final prefs = await SharedPreferences.getInstance();
    
    final List<Map<String, dynamic>> jsonList = exams.map((exam) => exam.toJson()).toList();
    
    final String examString = jsonEncode(jsonList);
    
    await prefs.setString(_storageKey, examString);
  }

  static Future<void> create(Exam exam) async {
    final List<Exam> exams = await readAllExams();
    exams.add(exam);
    await _saveExams(exams);
  }

  static Future<void> update(Exam updatedExam) async {
    final List<Exam> exams = await readAllExams();
    
    final int index = exams.indexWhere((exam) => exam.id == updatedExam.id);
    
    if (index != -1) {
      exams[index] = updatedExam;
      await _saveExams(exams);
    }
  }

  static Future<void> delete(String id) async {
    final List<Exam> exams = await readAllExams();
    
    exams.removeWhere((exam) => exam.id == id);
    
    await _saveExams(exams);
  }
}


class ExamListScreen extends StatefulWidget {
  const ExamListScreen({super.key});

  @override
  State<ExamListScreen> createState() => _ExamListScreenState();
}

class _ExamListScreenState extends State<ExamListScreen> {
  List<Exam> _exams = [];
  List<Exam> _filteredExams = [];
  Exam? _nextExam;
  bool _isLoading = true;
  final TextEditingController _searchController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _refreshExams();
    _searchController.addListener(_filterExams);
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  void _refreshExams() {
    setState(() => _isLoading = true);

    ExamStorage.readAllExams().then((data) {
      final now = DateTime.now();
      
      data.sort((a, b) => a.dateTime.compareTo(b.dateTime));

      Exam? foundNextExam;
      for (var exam in data) {
        if (exam.dateTime.isAfter(now)) {
          foundNextExam = exam;
          break;
        }
      }

      setState(() {
        _exams = data;
        _nextExam = foundNextExam;
        _filterExams();
        _isLoading = false;
      });
    });
  }

  void _filterExams() {
    final query = _searchController.text.toLowerCase();
    setState(() {
      _filteredExams = _exams
          .where((exam) => exam.courseCode.toLowerCase().contains(query))
          .toList();
    });
  }

  void _navigateAndRefresh(BuildContext context, {Exam? exam}) {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => ExamEntryScreen(exam: exam)),
    ).then((_) {
      _refreshExams();
    });
  }

  Widget _buildCountdownCard() {
    if (_nextExam == null) {
      return const SizedBox.shrink();
    }

    final now = DateTime.now();
    final difference = _nextExam!.date.difference(DateTime(now.year, now.month, now.day)).inDays;
    String countdownText;

    if (difference == 0) {
      countdownText = "Today";
    } else if (difference == 1) {
      countdownText = "in 1 day";
    } else {
      countdownText = "in $difference days";
    }
    
    return Card(
      color: Colors.indigo.shade700,
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Text(
          'Next Exam $countdownText: ${_nextExam!.courseCode}',
          style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.white),
          textAlign: TextAlign.center,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Exam Schedule'),
      ),
      body: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : Padding(
              padding: const EdgeInsets.all(8.0),
              child: Column(
                children: [
                  _buildCountdownCard(),
                  const SizedBox(height: 8),
                  TextField(
                    controller: _searchController,
                    decoration: const InputDecoration(
                      labelText: 'Search by Course Code',
                      prefixIcon: Icon(Icons.search),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.all(Radius.circular(12.0)),
                      ),
                    ),
                  ),
                  const SizedBox(height: 8),
                  Expanded(
                    child: _filteredExams.isEmpty
                        ? const Center(child: Text('No exams found.'))
                        : ListView.builder(
                            itemCount: _filteredExams.length,
                            itemBuilder: (context, index) {
                              final exam = _filteredExams[index];
                              final isNextExam = exam.id == _nextExam?.id;
                              return Card(
                                color: isNextExam ? Colors.indigo.withOpacity(0.3) : null,
                                child: ListTile(
                                  title: Text(exam.courseCode, style: const TextStyle(fontWeight: FontWeight.bold)),
                                  subtitle: Text('${DateFormat.yMMMd().format(exam.date)} at ${exam.time.format(context)}\nVenue: ${exam.venue}'),
                                  isThreeLine: true,
                                  trailing: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    children: [
                                      if (exam.documentPath != null && exam.documentPath!.isNotEmpty)
                                        IconButton(
                                          icon: const Icon(Icons.attach_file, color: Colors.blueAccent),
                                          onPressed: () => OpenFile.open(exam.documentPath),
                                        ),
                                      IconButton(
                                        icon: const Icon(Icons.edit, color: Colors.grey),
                                        onPressed: () => _navigateAndRefresh(context, exam: exam),
                                      ),
                                      IconButton(
                                        icon: const Icon(Icons.delete, color: Colors.redAccent),
                                        onPressed: () {
                                          ExamStorage.delete(exam.id).then((_){
                                            _refreshExams();
                                          });
                                        },
                                      ),
                                    ],
                                  ),
                                ),
                              );
                            },
                          ),
                  ),
                ],
              ),
            ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => _navigateAndRefresh(context),
        child: const Icon(Icons.add),
      ),
    );
  }
}

class ExamEntryScreen extends StatefulWidget {
  final Exam? exam;

  const ExamEntryScreen({super.key, this.exam});

  @override
  State<ExamEntryScreen> createState() => _ExamEntryScreenState();
}

class _ExamEntryScreenState extends State<ExamEntryScreen> {
  final _formKey = GlobalKey<FormState>();
  late TextEditingController _courseCodeController;
  late TextEditingController _venueController;
  DateTime? _selectedDate;
  TimeOfDay? _selectedTime;
  String? _documentPath;
  String? _documentName;

  @override
  void initState() {
    super.initState();
    _courseCodeController = TextEditingController(text: widget.exam?.courseCode);
    _venueController = TextEditingController(text: widget.exam?.venue);
    _selectedDate = widget.exam?.date;
    _selectedTime = widget.exam?.time;
    _documentPath = widget.exam?.documentPath;
    if (_documentPath != null) {
      _documentName = basename(_documentPath!);
    }
  }

  @override
  void dispose() {
    _courseCodeController.dispose();
    _venueController.dispose();
    super.dispose();
  }

  void _selectDate() {
    showDatePicker(
      context: context,
      initialDate: _selectedDate ?? DateTime.now(),
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
    ).then((pickedDate) {
      if (pickedDate != null && pickedDate != _selectedDate) {
        setState(() {
          _selectedDate = pickedDate;
        });
      }
    });
  }

  void _selectTime() {
    showTimePicker(
      context: context,
      initialTime: _selectedTime ?? TimeOfDay.now(),
    ).then((pickedTime) {
      if (pickedTime != null && pickedTime != _selectedTime) {
        setState(() {
          _selectedTime = pickedTime;
        });
      }
    });
  }

  void _pickDocument() {
    FilePicker.platform.pickFiles().then((result) {
      if (result != null) {
        setState(() {
          _documentPath = result.files.single.path;
          _documentName = result.files.single.name;
        });
      }
    });
  }

  void _saveExam() {
    if (_formKey.currentState!.validate() && _selectedDate != null && _selectedTime != null) {
      final exam = Exam(
        id: widget.exam?.id,
        courseCode: _courseCodeController.text,
        venue: _venueController.text,
        date: _selectedDate!,
        time: _selectedTime!,
        documentPath: _documentPath,
      );

      if (widget.exam == null) {
        ExamStorage.create(exam).then((_) {
          if (mounted) Navigator.of(context).pop();
        });
      } else {
        ExamStorage.update(exam).then((_) {
          if (mounted) Navigator.of(context).pop();
        });
      }
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please fill all fields and select date/time')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.exam == null ? 'Add Exam' : 'Edit Exam'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16.0),
        child: Form(
          key: _formKey,
          child: Column(
            crossAxisAlignment- CrossAxisAlignment.stretch,
            children: [
              TextFormField(
                controller: _courseCodeController,
                decoration: const InputDecoration(labelText: 'Course Code'),
                validator: (value) => value!.isEmpty ? 'Please enter course code' : null,
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _venueController,
                decoration: const InputDecoration(labelText: 'Venue'),
                validator: (value) => value!.isEmpty ? 'Please enter venue' : null,
              ),
              const SizedBox(height: 16),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(_selectedDate == null ? 'No date chosen' : DateFormat.yMMMd().format(_selectedDate!)),
                  TextButton(onPressed: _selectDate, child: const Text('Choose Date')),
                ],
              ),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(_selectedTime == null ? 'No time chosen' : _selectedTime!.format(context)),
                  TextButton(onPressed: _selectTime, child: const Text('Choose Time')),
                ],
              ),
              const SizedBox(height: 16),
              OutlinedButton.icon(
                onPressed: _pickDocument,
                icon: const Icon(Icons.upload_file),
                label: const Text('Upload Supporting Document'),
              ),
              if (_documentName != null)
                Padding(
                  padding: const EdgeInsets.only(top: 8.0),
                  child: Chip(
                    label: Text(_documentName!),
                    onDeleted: () {
                      setState(() {
                        _documentPath = null;
                        _documentName = null;
                      });
                    },
                  ),
                ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: _saveExam,
                style: ElevatedButton.styleFrom(
                  padding: const EdgeInsets.symmetric(vertical: 16),
                ),
                child: const Text('Save Exam'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

dependencies:
  flutter:
    sdk: flutter
  shared_preferences: ^2.2.3
  path_provider: ^2.1.3
  intl: ^0.19.0
  file_picker: ^8.0.3
  open_file_plus: ^3.4.1
  path: ^1.9.0